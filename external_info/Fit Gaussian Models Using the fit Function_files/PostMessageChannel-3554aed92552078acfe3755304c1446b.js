var MW;MW===undefined&&(MW={}),MW.postmessagechannel===undefined&&(MW.postmessagechannel={}),MW.postmessagechannel.PostMessageChannel=function(){"use strict";var i,s,e;return s={generate:function(){return(new Date).getTime().toString()}},(i=function(e,t,n){this.type=e,this.body=t,this.identifier=n||s.generate()}).serialize=function(e,t){return t+JSON.stringify([e.type,e.body,e.identifier])},i.deserialize=function(e,t){var n;return 0!==e.indexOf(t)?new i:(n=JSON.parse(e.replace(t,"")),new i(n[0],n[1],n[2]))},i.prototype.isValid=function(){return this.type&&null!==this.body},i.prototype.setEvent=function(e){this.event=e},(e=function(e,t){var n=this;this.tag=t||"__mwpmc__",this.localWindow=e,this.listeners={},this.callbacks={},this.onMessage=function(e){var t=i.deserialize(e.data,n.tag);t.isValid()&&n.hasListener(t.type)&&(t.setEvent(e),n.listeners[t.type].call(n,t),null===t.type.match(/^__/)&&n.send("__success",t.identifier))},this.on("__success",function(e){var t=e.body;this.callbacks[t]&&this.callbacks[t].onSuccess&&(this.callbacks[t].onSuccess.call(this),delete this.callbacks[t])}),this.addPostMessageListener()}).prototype.disconnect=function(){this.targetWindow=null,this.listeners={},this.localWindow.removeEventListener("message",this.onMessage)},e.prototype.listen=function(){this.on("__connect",function(e){this.setTargetWindow(e.event.source)})},e.prototype.connect=function(e){this.setTargetWindow(e),this.send("__connect",this.localWindow.location.origin),this.send("connect",this.localWindow.location.origin)},e.prototype.on=function(e,t){this.listeners[e]=t},e.prototype.hasListener=function(e){return this.listeners[e]!==undefined},e.prototype.send=function(e,t,n){var s=new i(e,t||"");n!==undefined&&(this.callbacks[s.identifier]=n),this.targetWindow.postMessage(i.serialize(s,this.tag),"*")},e.prototype.addPostMessageListener=function(){this.localWindow.addEventListener("message",this.onMessage,!1)},e.prototype.setTargetWindow=function(e){this.targetWindow=e},e}();